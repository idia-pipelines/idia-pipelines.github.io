<!DOCTYPE html>

<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  

  <title>SLURM and MPICASA - IDIA Pipelines</title>
  <link rel="stylesheet" href="http://localhost:4000/assets/css/just-the-docs.css">
  
  <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="http://localhost:4000/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

  <div class="page-wrap">
    <div class="side-bar">
      <a href="http://localhost:4000/" class="site-title fs-6 lh-tight">IDIA Pipelines</a>
      <span class="fs-3"><button class="js-main-nav-trigger navigation-list-toggle btn btn-outline" type="button" data-text-toggle="Hide">Menu</button></span>
      <div class="navigation main-nav js-main-nav">
        <nav role="navigation" aria-label="Main navigation">
  <ul class="navigation-list">
    
    
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/" class="navigation-list-link">Home</a>
            
          </li>
        
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/docs/access/" class="navigation-list-link">Access to IDIA Machines</a>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item active">
            
            <a href="http://localhost:4000/docs/processMeerKAT" class="navigation-list-link">processMeerKAT</a>
            
              
              <ul class="navigation-list-child-list ">
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Quick-Start/" class="navigation-list-link">Quick Start</a>
                      
                    </li>
                  
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Release-Notes/" class="navigation-list-link">Release Notes</a>
                      
                    </li>
                  
                
                  
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/using-the-pipeline/" class="navigation-list-link">Using the Pipeline</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Example-Use-Cases/" class="navigation-list-link">Example Use Cases</a>
                      
                    </li>
                  
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Diagnosing-Errors/" class="navigation-list-link">Diagnosing Errors</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/deep-2-tutorial/" class="navigation-list-link">DEEP 2 Tutorial</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/calibration-in-processmeerkat/" class="navigation-list-link">Cross-calibration in processMeerKAT</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/selfcalibration-in-processmeerkat/" class="navigation-list-link">Self-calibration in processMeerKAT</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item  active">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/SLURM-and-MPICASA/" class="navigation-list-link active">SLURM and MPICASA</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/LICENSE/" class="navigation-list-link">LICENSE</a>
                      
                    </li>
                  
                
              </ul>
            
          </li>
        
      
    
      
        
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/docs/containers/" class="navigation-list-link">Singularity Containers</a>
            
          </li>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
  </ul>
</nav>

      </div>
      <footer role="contentinfo" class="site-footer">
        <p class="text-small text-grey-dk-000 mb-0">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p>
      </footer>
    </div>
    <div class="main-content-wrap">
      <div class="page-header">
        <div class="main-content">
          
          <div class="search js-search">
            <div class="search-input-wrap">
              <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search IDIA Pipelines" aria-label="Search IDIA Pipelines" autocomplete="off">
              <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg>
            </div>
            <div class="js-search-results search-results-wrap"></div>
          </div>
          
          
            <ul class="list-style-none text-small mt-md-1 mb-md-1 pb-4 pb-md-0 js-aux-nav aux-nav">
              
                <li class="d-inline-block my-0"><a href="//github.com/idia-astro/pipelines/wiki">IDIA Pipelines</a></li>
              
            </ul>
          
        </div>
      </div>
      <div class="main-content js-main-content" tabindex="0">
        
          
            <nav class="breadcrumb-nav">
              <ol class="breadcrumb-nav-list">
                
                  <li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/docs/processMeerKAT">processMeerKAT</a></li>
                
                <li class="breadcrumb-nav-list-item"><span>SLURM and MPICASA</span></li>
              </ol>
            </nav>
          
        
        <div id="main-content" class="page-content" role="main">
          <h1 id="parallel-casa-using-slurm-at-idia">Parallel CASA Using SLURM at IDIA</h1>

<p><strong>Note: For details on how to setup SLURM batch and interactive jobs on the ilifu system, please look at the <a href="https://docs.ilifu.ac.za/#/getting_started/submit_job_slurm">ilifu documentation</a>.</strong></p>

<p>This page deals with the specifics of using CASA in conjuction with the SLURM environment on the ilifu computing system.</p>

<p>SLURM is a resource and job management system that is available on many clusters. Jobs/tasks are typically submitted to the job management system, and are inserted into a job queue; the job is executed when the requested resources become available. SLURM is currently used with the IDIA cluster.</p>

<p>While SLURM Clusters provide the option to request and reserve resources to work in an interactive mode, its preferred to submit jobs to the queue to be run in a non-interactive way.</p>

<p>To run a CASA script in a non-interactive way in the SLURM cluster, you would use the following steps.</p>

<ol>
  <li>Write your CASA script.</li>
  <li>Write an associated SBATCH script for your job.</li>
  <li>Submit the script (i.e., your job) to the queue using <code class="highlighter-rouge">sbatch</code>.</li>
</ol>

<!---

_**The image below illustrates these different steps.**_

![Basic step-by-step guide on to use SLURM and MPICASA to run a CASA Script.](/assets/slurm-and-mpicasa.png)

--->

<h2 id="write-your-casa-script">Write your CASA Script</h2>
<p>CASA scripts are written in Python. An entire pipeline can be written in such a script, that includes flagging, initial calibration and imaging.</p>

<p>It is important to note that different CASA tasks use different schemes for parallelism, when writing your script. For example, <code class="highlighter-rouge">flagdata</code> parallelises by scan and is thus RAM intensive; <code class="highlighter-rouge">tclean</code> splits up the input data to occupy as many processes are are specified, and is this CPU &amp; RAM intensive.</p>

<p>Therefore, a single script that includes flagging and imaging could have sub-optimal usage of a cluster resources for some tasks, and optimal usage for others. Keep this in mind when writing your script.</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vis = '/path/to/visibility.ms'
var1 = 'something'
var2 = 1e-3
casatask(vis=vis,
  var1=var1,
  var2=var2)

casatask2(vis=vis)
</code></pre></div></div>

<h2 id="write-your-sbatch-script">Write your SBATCH Script</h2>
<p>An SBATCH script is a bash script that wraps the relevant SLURM parameters needed for your script. Consult the following website for more details on how to use SBATCH:
https://slurm.schedmd.com/sbatch.html</p>

<p>Here’s an example of an SBATCH script that submits a TCLEAN job:</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/bin/bash</span>
<span class="c">#SBATCH -N 4-4</span>
<span class="c">#SBATCH --tasks-per-node 48</span>
<span class="c">#SBATCH -J tclean</span>
<span class="c">#SBATCH -m plane=8</span>
<span class="c">#SBATCH -o /path/to/stdout.log</span>
<span class="c">#SBATCH -e /path/to/stderr.log</span>

<span class="c">#Run the application:</span>
/path/to/casa-prerelease-5.3.0-115.el7/bin/mpicasa /usr/bin/singularity <span class="nb">exec</span> /path/to/casa/container.simg  <span class="s2">"casa"</span> <span class="nt">--nologger</span> <span class="nt">--log2term</span> <span class="nt">--nogui</span> <span class="nt">-c</span> tclean.py
</code></pre></div></div>

<p>You can find more details on how to use Singularity on ilifu on <a href="https://docs.ilifu.ac.za/#/getting_started/container_environments">their website</a>.</p>

<p>There are a few important SBATCH parameters to define:</p>

<ul>
  <li><code class="highlighter-rouge">--nodes</code> or <code class="highlighter-rouge">-N</code> specifies the node count, i.e., the nodes requested for the job.</li>
  <li><code class="highlighter-rouge">--tasks-per-node</code> specifies the number of parallel tasks to execute on each node.</li>
  <li><code class="highlighter-rouge">--mode</code> or <code class="highlighter-rouge">-m</code> specifies the mode in which the tasks are distributed to each node.
    <ul>
      <li>This parameter is useful for scripts that include flagging. Since flagging is parallelised by scan, the first node(s) could run out of RAM for a particular flagging job. This would lead to SLURM killing the offending task(s), hence killing the main job.</li>
      <li>There are two distribution modes that can be used to solve this problem. <code class="highlighter-rouge">plane=X</code> distributes X jobs at a time, in a round-robin fashion across nodes. The <code class="highlighter-rouge">cyclic</code> mode distributes single tasks at a time in a round-robin fashion across nodes.</li>
      <li><code class="highlighter-rouge">plane=X</code> or <code class="highlighter-rouge">cyclic</code> modes are useful for jobs that are RAM limited, i.e., when you need to use the aggregated RAM that’s in the total pool requested.</li>
    </ul>
  </li>
  <li>The <code class="highlighter-rouge">-J</code>, <code class="highlighter-rouge">-o</code> and <code class="highlighter-rouge">-e</code> parameters</li>
</ul>

<h3 id="more-about-slurm">More about SLURM</h3>
<p><a href="https://slurm.schedmd.com/overview.html">SLURM</a> is a workload manager that will distribute jobs across a specified cluster environment. It understands how to control an MPI-aware job via <code class="highlighter-rouge">mpirun</code> and hence also via <code class="highlighter-rouge">mpicasa</code>. In principle this means that SLURM should be able to schedule and manage a CASA job that is running across a cluster.</p>

<p>Following is a “practical” definition of some SLURM keywords that should help clarify how to best to allocate resources.</p>

<p><strong>task</strong> : A “task” by SLURM’s definition is what one would usually call a “process” on a regular computer. Similar to a process, a task has its own memory allocation that it does not share with other tasks. Each task is then operated on independently via MPI. This also means a more <em>fine-grained</em> parallelism can be employed per task, by using multiple threads (<em>e.g.</em> via openMP) to work on a single task.</p>

<p><strong>–cpus-per-task</strong> : Defines the number of CPUs to dedicate to a single task. If each task can take advantage of multiple threads, setting this value to more than one can speed things up further (<em>e.g.,</em> <code class="highlighter-rouge">tclean</code> in CASA is parallelised across openMP and MPI)</p>

<p><strong>–mem-per-cpu</strong> : The RAM dedicated to each CPU in the node. At the moment, the IDIA cluster is set to 4096MB per CPU. If a job is running out of memory, setting this to a larger value can help. Alternatively, as mentioned above if the task can take advantage of more threads, it may be preferable to set <code class="highlighter-rouge">--cpus-per-task</code> instead.</p>

<p><strong>-m/–distribution</strong> : This controls how the tasks are allocated across the requested nodes. The sbatch <code class="highlighter-rouge">man</code> page has a very good explanation on the various modes available.</p>

<hr />

<h3 id="notes-on-casa-tasks-and-parallelism">Notes on CASA Tasks and Parallelism</h3>

<p>Running CASA through SLURM requires calling CASA via <code class="highlighter-rouge">mpicasa</code>. CASA understands how to use <code class="highlighter-rouge">mpi</code> on tasks that are optimised for <code class="highlighter-rouge">mpi</code> (such as <code class="highlighter-rouge">flagdata</code>, <code class="highlighter-rouge">tclean</code>, <code class="highlighter-rouge">setjy</code>, and <code class="highlighter-rouge">applycal</code>) while operating as per usual on tasks that are not <code class="highlighter-rouge">mpi</code> aware (like <code class="highlighter-rouge">gaincal</code>). Ideally, the only change to an existing script would be to add a call to <code class="highlighter-rouge">partition</code> at the top. Below are some notes on tasks.</p>

<p><strong>partition</strong>: In order to run tasks (except tclean) across a cluster, the <code class="highlighter-rouge">partition</code> task needs to be called prior to running any other tasks. <code class="highlighter-rouge">partition</code>  <a href="https://casa.nrao.edu/casadocs/casa-5.4.1/uv-manipulation/data-partition">creates a multi-measurement set</a> (MMS) that is a collection of multiple SUBMS’s, each of which will be operated upon as a task in SLURM. By default CASA will split the MS along the spectral window (<code class="highlighter-rouge">spw</code>) axis, and across scans.</p>

<!--
The number of SUBMSes created can be specified in `partition`, however it seems that specifying a number larger than what CASA would decide leads to some strangeness with the metadata (and a failure of tasks that operate on the MMS).
-->

<p><strong>tclean</strong>: In order to run across a cluster, <code class="highlighter-rouge">parallel=True</code> should be specified in <code class="highlighter-rouge">tclean</code>. However, if <code class="highlighter-rouge">savemodel='modelcolumn'</code> is also specified, it triggers some kind of a race condition between the different nodes where they are competing for write access, and the task crashes. So setting <code class="highlighter-rouge">savemodel='virtual'</code> or <code class="highlighter-rouge">savemodel='none'</code> are the only options that work. Both the <code class="highlighter-rouge">makePSF</code> step and the major cycles of deconvolution are openMP aware, and can exploit additional resources specified via <code class="highlighter-rouge">--cpus-per-task</code> in the SLURM <code class="highlighter-rouge">sbatch</code> file.</p>


          
        </div>
      </div>
    </div>
  </div>

</body>
</html>
