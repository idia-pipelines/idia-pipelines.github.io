<!DOCTYPE html>

<html lang="en-us">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=Edge">
  

  <title>Advanced Usage - IDIA Pipelines</title>
  <link rel="stylesheet" href="http://localhost:4000/assets/css/just-the-docs.css">
  
  <script type="text/javascript" src="http://localhost:4000/assets/js/vendor/lunr.min.js"></script>
  
  <script type="text/javascript" src="http://localhost:4000/assets/js/just-the-docs.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1">
</head>

<body>

  <div class="page-wrap">
    <div class="side-bar">
      <a href="http://localhost:4000/" class="site-title fs-6 lh-tight">IDIA Pipelines</a>
      <span class="fs-3"><button class="js-main-nav-trigger navigation-list-toggle btn btn-outline" type="button" data-text-toggle="Hide">Menu</button></span>
      <div class="navigation main-nav js-main-nav">
        <nav role="navigation" aria-label="Main navigation">
  <ul class="navigation-list">
    
    
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/" class="navigation-list-link">Home</a>
            
          </li>
        
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/docs/access/" class="navigation-list-link">Access to IDIA Machines</a>
            
          </li>
        
      
    
      
        
          <li class="navigation-list-item active">
            
            <a href="http://localhost:4000/docs/processMeerKAT" class="navigation-list-link">processMeerKAT</a>
            
              
              <ul class="navigation-list-child-list ">
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Quick-Start/" class="navigation-list-link">Quick Start</a>
                      
                    </li>
                  
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Release-Notes/" class="navigation-list-link">Release Notes</a>
                      
                    </li>
                  
                
                  
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/using-the-pipeline/" class="navigation-list-link">Using the Pipeline</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Example-Use-Cases/" class="navigation-list-link">Example Use Cases</a>
                      
                    </li>
                  
                
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Diagnosing-Errors/" class="navigation-list-link">Diagnosing Errors</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/config-files/" class="navigation-list-link">Configuration Files</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/cross-calibration-in-processmeerkat/" class="navigation-list-link">Cross-calibration in processMeerKAT</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/self-calibration-in-processmeerkat/" class="navigation-list-link">Self-calibration in processMeerKAT</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/science-imaging-in-processmeerkat/" class="navigation-list-link">Science Imaging in processMeerKAT</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/deep-2-tutorial/" class="navigation-list-link">DEEP 2 Tutorial</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item  active">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/Advanced-Usage/" class="navigation-list-link active">Advanced Usage</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/SLURM-and-MPICASA/" class="navigation-list-link">SLURM and MPICASA</a>
                      
                    </li>
                  
                
                  
                    <li class="navigation-list-item ">
                      
                      <a href="http://localhost:4000/docs/processMeerKAT/LICENSE/" class="navigation-list-link">LICENSE</a>
                      
                    </li>
                  
                
              </ul>
            
          </li>
        
      
    
      
        
      
    
      
        
      
    
      
        
          <li class="navigation-list-item">
            
            <a href="http://localhost:4000/docs/containers/" class="navigation-list-link">Singularity Containers</a>
            
          </li>
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
      
        
      
    
  </ul>
</nav>

      </div>
      <footer role="contentinfo" class="site-footer">
        <p class="text-small text-grey-dk-000 mb-0">This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</p>
      </footer>
    </div>
    <div class="main-content-wrap">
      <div class="page-header">
        <div class="main-content">
          
          <div class="search js-search">
            <div class="search-input-wrap">
              <input type="text" class="js-search-input search-input" tabindex="0" placeholder="Search IDIA Pipelines" aria-label="Search IDIA Pipelines" autocomplete="off">
              <svg width="14" height="14" viewBox="0 0 28 28" xmlns="http://www.w3.org/2000/svg" class="search-icon"><title>Search</title><g fill-rule="nonzero"><path d="M17.332 20.735c-5.537 0-10-4.6-10-10.247 0-5.646 4.463-10.247 10-10.247 5.536 0 10 4.601 10 10.247s-4.464 10.247-10 10.247zm0-4c3.3 0 6-2.783 6-6.247 0-3.463-2.7-6.247-6-6.247s-6 2.784-6 6.247c0 3.464 2.7 6.247 6 6.247z"/><path d="M11.672 13.791L.192 25.271 3.02 28.1 14.5 16.62z"/></g></svg>
            </div>
            <div class="js-search-results search-results-wrap"></div>
          </div>
          
          
            <ul class="list-style-none text-small mt-md-1 mb-md-1 pb-4 pb-md-0 js-aux-nav aux-nav">
              
                <li class="d-inline-block my-0"><a href="//github.com/idia-astro/pipelines/wiki">IDIA Pipelines</a></li>
              
            </ul>
          
        </div>
      </div>
      <div class="main-content js-main-content" tabindex="0">
        
          
            <nav class="breadcrumb-nav">
              <ol class="breadcrumb-nav-list">
                
                  <li class="breadcrumb-nav-list-item"><a href="http://localhost:4000/docs/processMeerKAT">processMeerKAT</a></li>
                
                <li class="breadcrumb-nav-list-item"><span>Advanced Usage</span></li>
              </ol>
            </nav>
          
        
        <div id="main-content" class="page-content" role="main">
          <h1 id="inserting-your-own-scripts">Inserting your own scripts</h1>

<p>Our design allows the user to insert their own scripts into the pipeline, along with or instead of our own scripts. All scripts are assumed to be written in python, with extension <code class="highlighter-rouge">.py</code>. They must either have hard-coded values for input such as the MS name, or be able to read the config file and extract the values (e.g. as in the main() function of most of our scripts).</p>

<p>To insert your own scripts, either build a config file and edit the <code class="highlighter-rouge">scripts</code>, <code class="highlighter-rouge">precal_scripts</code> or <code class="highlighter-rouge">postcal_scripts</code> parameters (see <a href="/docs/processMeerKAT/config-files#spw-splitting">SPW splitting</a>) argument to contain your list of scripts, or pass your scripts via command line during building your config file. For each script that is added, three arguments are needed</p>

<ol>
  <li>The path to the script</li>
  <li>Whether the script is threadsafe (for MPI - i.e. it can use <code class="highlighter-rouge">casampi</code>)</li>
  <li>The path to the container with which to call the script - use <code class="highlighter-rouge">''</code> for the default container</li>
</ol>

<p>The path to the scripts (and containers) can be an absolute path, a relative path, or in your bash path. If none of these exist, the script is assumed to be in one of the pipeline scripts directories (e.g. <code class="highlighter-rouge">/idia/software/pipelines/master/processMeerKAT</code> and below). Hence simply using <code class="highlighter-rouge">partition.py</code> will call the partition script in the cross-calibration scripts directory.</p>

<h2 id="adding-scripts-to-config-file">Adding scripts to config file</h2>

<p>Edit the <code class="highlighter-rouge">scripts</code>, <code class="highlighter-rouge">precal_scripts</code> or <code class="highlighter-rouge">postcal_scripts</code> parameters (see <a href="/docs/processMeerKAT/config-files#spw-splitting">SPW splitting</a>) in your config file, which must be a list of lists/tuples.</p>

<h2 id="adding-scripts-via-command-line">Adding scripts via command line</h2>

<p>Build a config file pointing to your scripts, each time appending the same three arguments (listed above):</p>

<p><code class="highlighter-rouge">processMeerKAT.py -B -C myconfig.txt -S /absolute/path/to/my/script.py False /absolute/path/to/container.simg -S partition.py True '' -S relative/path/to/my/script.py True relative/path/to/container.simg -S flag_round_1.py True '' -S script_in_bash_PATH.py False container_in_bash_path.simg -S setjy.py True ''</code></p>

<p>An error will be raised if any of the scripts or containers aren’t found.</p>

<p>Similarly, the <code class="highlighter-rouge">[-b --precal_scripts]</code> and <code class="highlighter-rouge">[-a --postcal_scripts]</code> parameters can be used to add precal and postcal scripts (see <a href="/docs/processMeerKAT/config-files#spw-splitting">SPW splitting</a>) via the command line, with the same syntax.</p>

<h1 id="editing-pipeline-scripts">Editing pipeline scripts</h1>

<p>Users may wish to edit some of the pipeline scripts to do their own custom progressing by changing CASA task parameters not exposed via the config file. To do so, first copy the script (e.g. from <code class="highlighter-rouge">/idia/software/pipelines/master/processMeerKAT/crosscal_scripts/</code>) to your working directory, and then edit it from there. The pipeline will first look for a local copy of the pipeline scripts (in your working directory and the one above) and run this instead of the normal version of the script.</p>

<!-- If you can't find the script, type `which processMeerKAT.py` into your terminal, and then search in the same directory (e.g. `which `) -->

<h1 id="restarting-or-resuming-the-pipeline">Restarting or Resuming the Pipeline</h1>

<p>The pipeline can be killed (via <code class="highlighter-rouge">./killJobs.sh</code>) and re-run from the start at any point. However, this is not always necessary. The pipeline is generally not designed to run twice within the same directory, since CASA will complain the files already exist. However, the pipeline can be resumed by skipping certain steps, achieved by editing the <code class="highlighter-rouge">scripts</code> parameter in your config file and removing the steps that have already been run.</p>

<p>As the hidden config (<code class="highlighter-rouge">.config.tmp</code>) is updated during your pipeline run, you may first wish to check the differences (e.g. with <code class="highlighter-rouge">diff myconfig.txt .config.tmp</code>) and update your config accordingly. For example, the <code class="highlighter-rouge">vis</code> or reference antennas (and bad antennas) may have been updated. If you remove the <code class="highlighter-rouge">partition</code> step, and you have <code class="highlighter-rouge">nspw</code> &gt; 1, the pipeline will attempt to update the config files in your SPW directories by updating the <code class="highlighter-rouge">vis</code> to the partitioned (M)MS.</p>

<p>Particular care should also be taken in cases where a job crashed during writing to a column of your (M)MS (e.g. during flagging, applying, or <code class="highlighter-rouge">setjy</code>), to ensure the data are not corrupted. Checking the logs should reveal which step was being run, and if the job crashed while writing to the column, it is best to remove that (M)MS and re-run the relevant steps (or if necessary, wipe everything in your working directory and restart the pipeline). Similar care must be taken during steps where a new product was being written (e.g. <code class="highlighter-rouge">partition</code>, <code class="highlighter-rouge">split</code>, <code class="highlighter-rouge">concat</code>, or any of the imaging jobs). In such cases, it is best to remove the incomplete product(s) and re-run that step (and the subsequent ones). For example, if an imaging step crashed, remove the image products, patch any bugs that may have caused the crash (by correcting your config, or <a href="#editing-pipeline-scripts">editing the script for that step</a>), and re-run that step (and subsequent ones). Or if a split step crashed, remove the incomplete (M)MS, patch any bugs, and re-run.</p>

<p>There are a few steps within the pipeline that only need to be run once for a given dataset. For datasets that have already been through the default pipeline, the solutions from <code class="highlighter-rouge">xx_yy_solve</code> (or <code class="highlighter-rouge">xy_yx_solve</code>) have been written to the <code class="highlighter-rouge">caltables</code> directory (renamed to <code class="highlighter-rouge">caltables_round1</code> if a 2nd round is written, which is then written to <code class="highlighter-rouge">caltables</code>), which will automatically be applied during running <code class="highlighter-rouge">xx_yy_apply</code> (or <code class="highlighter-rouge">xy_yx_apply</code>). Simlarly, if <code class="highlighter-rouge">calcrefant=True</code> and the <code class="highlighter-rouge">calc_refant.py</code> script was included, the reference antenna and list of bad antennas would have been calculated, and can be found in <code class="highlighter-rouge">ant_stats.txt</code> (and <code class="highlighter-rouge">logs/calc_refant-*.err</code>). These can be written in your new config file (e.g. check <code class="highlighter-rouge">.config.tmp</code>), where you can now set <code class="highlighter-rouge">calcrefant=False</code>.</p>

<p>Other than editing the <code class="highlighter-rouge">scripts</code> parameter, users can run any selected parts of the pipeline by passing scripts in via the command-line arguments (see <a href="#inserting-your-own-scripts">above</a>). Users can also manually submit sbatch jobs corresponding to certain steps within the pipeline, although this will not be captured by the pipeline infrastructure, such as the bash <code class="highlighter-rouge">jobScripts</code>: <code class="highlighter-rouge">summary.sh</code>, <code class="highlighter-rouge">killJobs.sh</code>, etc.</p>

<h1 id="spectral-line-pre-processing">Spectral line pre-processing</h1>

<p>One advanced use case is to process continuum data at lower spectral resolution (e.g. 1k / 1024 channels), and apply that calibration to higher spectral-resolution data (e.g. 32k / 32,768 channels). There are several ways to do this, and an optimal method is to partition and fully calibrate a 1k copy of your data, and then partition a separate 32k copy. You can then use your fresh 32k copy to re-run bandpass calibration, apply your (cross-calibration and self-calibration) solutions, predict to the model column (based on your 1k images), and flag on the <code class="highlighter-rouge">RESIDUAL</code> column. This is achievable by “tricking” the pipeline into doing so by renaming or moving your previous (M)MSs, and partitioning out a fresh 32k copy with the same default names (and then replacing your bandpass caltable with a 32k bandpass solution). However, there are a few quirky steps involved in doing this, so please get in touch with us at <a href="mailto:support@ilifu.ac.za">ilifu Support</a> to ask about doing this.</p>

<p>Once your 32k data are calibrated, and have valid model and corrected data colums, a simple <code class="highlighter-rouge">uvsub</code> call can be made to subtract the continuum model from your data, and then a <code class="highlighter-rouge">uvcontsub</code> call with your preferred parameters can be run in parallel mode with <code class="highlighter-rouge">casampi</code>.</p>


          
        </div>
      </div>
    </div>
  </div>

</body>
</html>
